---
title: "Drizzleì™€ Vercel Postgres ì‚¬ìš©í•˜ê¸°"
date: "2024-06-09"
svgs: ['<svg width="160" height="160" viewBox="0 0 160 160" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 43.4805 67.3037)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 76.9395 46.5342)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 128.424 46.5352)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 94.957 67.3037)" fill="currentColor"></rect></svg>', <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 5L4 19H20L12 5Z" fill="currentColor" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>']
---

import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';

## Vercel Postgresì™€ Drizzle ORM ì„¤ì •í•˜ê¸°

ì´ íŠœí† ë¦¬ì–¼ì€ [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres)ì™€ Drizzle ORMì„ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. Vercel PostgresëŠ” Vercel Functionsì™€ ì—¬ëŸ¬ë¶„ì˜ í”„ë¡ íŠ¸ì—”ë“œ í”„ë ˆì„ì›Œí¬ì™€ í†µí•©ë˜ë„ë¡ ì„¤ê³„ëœ ì„œë²„ë¦¬ìŠ¤ SQL ë°ì´í„°ë² ì´ìŠ¤ì…ë‹ˆë‹¤.

<Prerequisites>
- Drizzle ORMê³¼ [Drizzle kit](/docs/kit-overview)ì„ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>

- í™˜ê²½ ë³€ìˆ˜ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ `dotenv` íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ì´ íŒ¨í‚¤ì§€ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ì—¬ê¸°](https://www.npmjs.com/package/dotenv)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<Npm>
  dotenv
</Npm>

- `@vercel/postgres` íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ì´ íŒ¨í‚¤ì§€ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ì—¬ê¸°](https://www.npmjs.com/package/@vercel/postgres)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<Npm>
  @vercel/postgres
</Npm>  
</Prerequisites>

Drizzle ORMì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ëŠ” ë°©ë²•ì€ [Vercel ë¬¸ì„œ](https://vercel.com/docs/storage/vercel-postgres/using-an-orm#drizzle)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

<Steps>


#### ìƒˆë¡œìš´ Vercel Postgres ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±í•˜ê¸°

[Vercel ëŒ€ì‹œë³´ë“œ](https://vercel.com/dashboard)ì—ì„œ ìƒˆë¡œìš´ Vercel Postgres ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìƒˆë¡œìš´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§Œë“œëŠ” ë°©ë²•ì€ Vercel Postgres [ê³µì‹ ë¬¸ì„œ](https://vercel.com/docs/storage/vercel-postgres/quickstart)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.


#### ì—°ê²° ë¬¸ìì—´ ë³€ìˆ˜ ì„¤ì •í•˜ê¸°

1. Vercel Postgres ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì´ë™í•©ë‹ˆë‹¤.
2. `.env.local` ì„¹ì…˜ì—ì„œ `POSTGRES_URL`ì„ ë³µì‚¬í•©ë‹ˆë‹¤.
3. `.env.local` ë˜ëŠ” `.env` íŒŒì¼ì— `POSTGRES_URL`ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

```plaintext
POSTGRES_URL=
```

ì´ì œ ì—¬ëŸ¬ë¶„ì˜ í”„ë¡œì íŠ¸ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ì„¤ì •í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.


#### Drizzle ORMì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ê¸°

`src/db` ë””ë ‰í† ë¦¬ì— `index.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •ì„ êµ¬ì„±í•©ë‹ˆë‹¤:

```typescript
// src/db/index.ts
import { drizzle } from 'drizzle-orm/vercel-postgres';
import { config } from 'dotenv';

// .env.local ë˜ëŠ” .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
config({ path: '.env.local' });

// Drizzle ORM ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
export const db = drizzle();
```

ì´ ì½”ë“œëŠ” Drizzle ORMì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ëŠ” ê¸°ë³¸ ì„¤ì •ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. í™˜ê²½ ë³€ìˆ˜ íŒŒì¼(`.env.local` ë˜ëŠ” `.env`)ì—ì„œ ì„¤ì •ì„ ì½ì–´ì™€ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.


#### í…Œì´ë¸” ìƒì„±í•˜ê¸°

`src/db` ë””ë ‰í† ë¦¬ì— `schema.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  í…Œì´ë¸”ì„ ì„ ì–¸í•©ë‹ˆë‹¤:

```typescript
import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(), // ê¸°ë³¸ í‚¤ë¡œ ì„¤ì •ëœ ìë™ ì¦ê°€ ID
  name: text('name').notNull(), // ì´ë¦„ í•„ë“œ (ë„ ê°’ í—ˆìš© ì•ˆ í•¨)
  age: integer('age').notNull(), // ë‚˜ì´ í•„ë“œ (ë„ ê°’ í—ˆìš© ì•ˆ í•¨)
  email: text('email').notNull().unique(), // ì´ë©”ì¼ í•„ë“œ (ë„ ê°’ í—ˆìš© ì•ˆ í•¨, ê³ ìœ  ê°’)
});

export const postsTable = pgTable('posts_table', {
  id: serial('id').primaryKey(), // ê¸°ë³¸ í‚¤ë¡œ ì„¤ì •ëœ ìë™ ì¦ê°€ ID
  title: text('title').notNull(), // ì œëª© í•„ë“œ (ë„ ê°’ í—ˆìš© ì•ˆ í•¨)
  content: text('content').notNull(), // ë‚´ìš© í•„ë“œ (ë„ ê°’ í—ˆìš© ì•ˆ í•¨)
  userId: integer('user_id') // ì‚¬ìš©ì ID í•„ë“œ
    .notNull() // ë„ ê°’ í—ˆìš© ì•ˆ í•¨
    .references(() => usersTable.id, { onDelete: 'cascade' }), // usersTableì˜ idë¥¼ ì°¸ì¡°, ì‚­ì œ ì‹œ ì—°ì‡„ ì‚­ì œ
  createdAt: timestamp('created_at').notNull().defaultNow(), // ìƒì„± ì‹œê°„ í•„ë“œ (í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ê¸°ë³¸ê°’ ì„¤ì •)
  updatedAt: timestamp('updated_at') // ì—…ë°ì´íŠ¸ ì‹œê°„ í•„ë“œ
    .notNull() // ë„ ê°’ í—ˆìš© ì•ˆ í•¨
    .$onUpdate(() => new Date()), // ì—…ë°ì´íŠ¸ ì‹œ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ìë™ ì„¤ì •
});

export type InsertUser = typeof usersTable.$inferInsert; // ì‚¬ìš©ì ì‚½ì… íƒ€ì…
export type SelectUser = typeof usersTable.$inferSelect; // ì‚¬ìš©ì ì„ íƒ íƒ€ì…

export type InsertPost = typeof postsTable.$inferInsert; // ê²Œì‹œë¬¼ ì‚½ì… íƒ€ì…
export type SelectPost = typeof postsTable.$inferSelect; // ê²Œì‹œë¬¼ ì„ íƒ íƒ€ì…
```


#### Drizzle ì„¤ì • íŒŒì¼ ì„¤ì •í•˜ê¸°

**Drizzle ì„¤ì • íŒŒì¼**ì€ [Drizzle Kit](/docs/kit-overview)ì—ì„œ ì‚¬ìš©í•˜ëŠ” êµ¬ì„± íŒŒì¼ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´, ë§ˆì´ê·¸ë ˆì´ì…˜ í´ë”, ìŠ¤í‚¤ë§ˆ íŒŒì¼ ë“±ì— ëŒ€í•œ ëª¨ë“  ì •ë³´ë¥¼ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `drizzle.config.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•˜ì„¸ìš”:

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from 'drizzle-kit';

// .env.local íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
config({ path: '.env.local' });

export default defineConfig({
  schema: './src/db/schema.ts', // ìŠ¤í‚¤ë§ˆ íŒŒì¼ ê²½ë¡œ
  out: './migrations',          // ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ ìƒì„±ë  ê²½ë¡œ
  dialect: 'postgresql',        // ë°ì´í„°ë² ì´ìŠ¤ ì¢…ë¥˜
  dbCredentials: {
    url: process.env.POSTGRES_URL!, // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° URL
  },
});
```

ì´ ì„¤ì • íŒŒì¼ì€ Drizzle Kitì´ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ê´€ë¦¬í•˜ê³  ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìƒì„±í•˜ëŠ” ë° í•„ìš”í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.


#### ë°ì´í„°ë² ì´ìŠ¤ì— ë³€ê²½ì‚¬í•­ ì ìš©í•˜ê¸°

`drizzle-kit generate` ì»¤ë§¨ë“œë¥¼ ì‚¬ìš©í•´ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìƒì„±í•˜ê³ , `drizzle-kit migrate` ì»¤ë§¨ë“œë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±:

```bash
npx drizzle-kit generate
```

ìƒì„±ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ì€ `drizzle.config.ts`ì— ì§€ì •ëœ `drizzle/migrations` ë””ë ‰í† ë¦¬ì— ì €ì¥ë©ë‹ˆë‹¤. ì´ ë””ë ‰í† ë¦¬ì—ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë° í•„ìš”í•œ SQL íŒŒì¼ê³¼, ë‹¤ì–‘í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„ì—ì„œì˜ ìŠ¤í‚¤ë§ˆ ìŠ¤ëƒ…ìƒ·ì„ ì €ì¥í•˜ëŠ” `meta` í´ë”ê°€ í¬í•¨ë©ë‹ˆë‹¤.

ìƒì„±ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì œ:

```sql
CREATE TABLE IF NOT EXISTS "posts_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"content" text NOT NULL,
	"user_id" integer NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" integer NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "posts_table" ADD CONSTRAINT "posts_table_user_id_users_table_id_fk" FOREIGN KEY ("user_id") REFERENCES "users_table"("id") ON DELETE cascade ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰:

```bash
npx drizzle-kit migrate
```

ë˜ëŠ”, [Drizzle kit push ì»¤ë§¨ë“œ](/docs/kit-overview#prototyping-with-db-push)ë¥¼ ì‚¬ìš©í•´ ë°ì´í„°ë² ì´ìŠ¤ì— ì§ì ‘ ë³€ê²½ì‚¬í•­ì„ ì ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:

```bash
npx drizzle-kit push
```

<Callout type="warning">
push ì»¤ë§¨ë“œëŠ” ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ ìƒˆë¡œìš´ ìŠ¤í‚¤ë§ˆ ë””ìì¸ì´ë‚˜ ë³€ê²½ì‚¬í•­ì„ ë¹ ë¥´ê²Œ í…ŒìŠ¤íŠ¸í•´ì•¼ í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ê´€ë¦¬í•˜ëŠ” ì˜¤ë²„í—¤ë“œ ì—†ì´ ë¹ ë¥´ê²Œ ë°˜ë³µ ì‘ì—…ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</Callout>

</Steps>


## ê¸°ë³¸ íŒŒì¼ êµ¬ì¡°

ì´ í”„ë¡œì íŠ¸ì˜ ê¸°ë³¸ íŒŒì¼ êµ¬ì¡°ì…ë‹ˆë‹¤. `src/db` ë””ë ‰í† ë¦¬ì—ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. `index.ts` íŒŒì¼ì—ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì½”ë“œê°€ ìˆê³ , `schema.ts` íŒŒì¼ì—ëŠ” ìŠ¤í‚¤ë§ˆ ì •ì˜ê°€ ìˆìŠµë‹ˆë‹¤.

```plaintext
ğŸ“¦ <project root>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ index.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“‚ migrations
 â”‚   â”œ ğŸ“‚ meta
 â”‚   â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”œ ğŸ“œ .env.local
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```


## ì¿¼ë¦¬ ì˜ˆì œ

ì˜ˆë¥¼ ë“¤ì–´, `src/db/queries` í´ë”ë¥¼ ë§Œë“¤ê³  ê° ì‘ì—…(insert, select, update, delete)ë³„ë¡œ íŒŒì¼ì„ ë¶„ë¦¬í•©ë‹ˆë‹¤.


#### ë°ì´í„° ì‚½ì…

ë°ì´í„° ì‚½ì… ì¿¼ë¦¬ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ë¬¸ì„œ](/docs/insert)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

```typescript copy filename="src/db/queries/insert.ts" {4, 8}
import { db } from '../index';
import { InsertPost, InsertUser, postsTable, usersTable } from '../schema';

export async function createUser(data: InsertUser) {
  await db.insert(usersTable).values(data);
}

export async function createPost(data: InsertPost) {
  await db.insert(postsTable).values(data);
}
```


#### ë°ì´í„° ì„ íƒ

[ë¬¸ì„œ](/docs/select)ì—ì„œ select ì¿¼ë¦¬ì— ëŒ€í•´ ë” ì•Œì•„ë³´ì„¸ìš”.

```typescript copy filename="src/db/queries/select.ts" {5, 16, 41}
import { asc, between, count, eq, getTableColumns, sql } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, postsTable, usersTable } from '../schema';

export async function getUserById(id: SelectUser['id']): Promise<
  Array<{
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db.select().from(usersTable).where(eq(usersTable.id, id));
}

export async function getUsersWithPostsCount(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    postsCount: number;
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db
    .select({
      ...getTableColumns(usersTable),
      postsCount: count(postsTable.id),
    })
    .from(usersTable)
    .leftJoin(postsTable, eq(usersTable.id, postsTable.userId))
    .groupBy(usersTable.id)
    .orderBy(asc(usersTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

export async function getPostsForLast24Hours(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    id: number;
    title: string;
  }>
> {
  return db
    .select({
      id: postsTable.id,
      title: postsTable.title,
    })
    .from(postsTable)
    .where(between(postsTable.createdAt, sql`now() - interval '1 day'`, sql`now()`))
    .orderBy(asc(postsTable.title), asc(postsTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}
```

ë˜ëŠ” [ê´€ê³„í˜• ì¿¼ë¦¬ êµ¬ë¬¸](/docs/rqb)ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.


#### ë°ì´í„° ì—…ë°ì´íŠ¸

ë°ì´í„° ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ë¬¸ì„œ](/docs/update)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

```typescript copy filename="src/db/queries/update.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectPost, postsTable } from '../schema';

export async function updatePost(id: SelectPost['id'], data: Partial<SelectPost>) {
  await db.update(postsTable).set(data).where(eq(postsTable.id, id));
}
```


#### ë°ì´í„° ì‚­ì œ

ì‚­ì œ ì¿¼ë¦¬ì— ëŒ€í•´ ë” ìì„¸íˆ ì•Œì•„ë³´ë ¤ë©´ [ë¬¸ì„œ](/docs/delete)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

```typescript copy filename="src/db/queries/delete.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, usersTable } from '../schema';

export async function deleteUser(id: SelectUser['id']) {
  await db.delete(usersTable).where(eq(usersTable.id, id));
}
```


