import Npm from "@mdx/Npm.astro";
import Steps from "@mdx/Steps.astro";

## ì‹œì‘í•˜ê¸°

---
title: "Sequelizeì—ì„œ Drizzleë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ê¸°"
---


ì´ ê°€ì´ë“œëŠ” ê¸°ë³¸ **Sequelize** í”„ë¡œì íŠ¸ë¥¼ **Drizzle ORM**ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ëŠ” ê°„ë‹¨í•œ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤. ì˜ˆì œëŠ” `PostgreSQL`ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ëª…í•˜ì§€ë§Œ, ë‹¤ë¥¸ ì§€ì› ë°ì´í„°ë² ì´ìŠ¤ì—ì„œë„ ë¹„ìŠ·í•œ ê³¼ì •ì„ ê±°ì¹©ë‹ˆë‹¤.


### ë§ˆì´ê·¸ë ˆì´ì…˜ í”„ë¡œì„¸ìŠ¤ ê°œìš”

ì—¬ëŸ¬ë¶„ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ íƒ€ì…ì´ë‚˜ API ë ˆì´ì–´ì— ìƒê´€ì—†ì´, **Sequelize**ì—ì„œ **Drizzle ORM**ìœ¼ë¡œ ì „í™˜í•˜ëŠ” ê³¼ì •ì€ ë™ì¼í•©ë‹ˆë‹¤:

1. **Drizzle ORM**ê³¼ **Drizzle Kit** ì„¤ì¹˜
2. **Drizzle config** íŒŒì¼ ì„¤ì •
3. ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ë¶„ì„
4. **Drizzle ORM**ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°
5. **Sequelize** ì¿¼ë¦¬ë¥¼ **Drizzle ORM** ì¿¼ë¦¬ë¡œ ì „í™˜

ì´ ë‹¨ê³„ë“¤ì€ REST API(ì˜ˆ: Express, Koa, NestJS ë“±)ë¥¼ ê°œë°œí•˜ê±°ë‚˜, **Sequelize**ë¥¼ ì‚¬ìš©í•´ ë°ì´í„°ë² ì´ìŠ¤ì™€ ìƒí˜¸ì‘ìš©í•˜ëŠ” ë‹¤ë¥¸ íƒ€ì…ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°œë°œí•  ë•Œ ëª¨ë‘ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


## Sequelize í”„ë¡œì íŠ¸ ê°œìš”

ì´ ê°€ì´ë“œì—ì„œëŠ” **Drizzle ORM**ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•  ì˜ˆì œ í”„ë¡œì íŠ¸ë¡œ `Express`ë¡œ êµ¬ì¶•ëœ REST APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ í”„ë¡œì íŠ¸ì—ëŠ” ë„¤ ê°€ì§€ ì—”í‹°í‹°ê°€ ìˆìŠµë‹ˆë‹¤:

```typescript collapsable copy filename="src/db/models/supplier.ts"
import { DataTypes, Model } from 'sequelize';
import { Product } from './product';
import { sequelize } from '../db';

export class Supplier extends Model {}

Supplier.init(
  {
    id: {
      type: DataTypes.INTEGER,
      autoIncrement: true,
      primaryKey: true,
    },
    companyName: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
    city: {
      type: DataTypes.TEXT,
      allowNull: true,
    },
    country: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'suppliers',
    modelName: 'Supplier',
    timestamps: false,
  },
);

Supplier.hasMany(Product, {
  foreignKey: 'supplierId',
});

Product.belongsTo(Supplier, {
  foreignKey: 'supplierId',
  targetKey: 'id',
});
```

```typescript collapsable copy filename="src/db/models/product.ts"
import { DataTypes, Model } from 'sequelize';
import { sequelize } from '../db';

export class Product extends Model {}

Product.init(
  {
    id: {
      type: DataTypes.INTEGER,
      autoIncrement: true,
      primaryKey: true,
    },
    name: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
    supplierId: {
      type: DataTypes.INTEGER,
      allowNull: false,
      references: {
        model: 'suppliers',
        key: 'id',
      },
      field: 'supplierId',
    },
    unitPrice: {
      type: DataTypes.DECIMAL,
      allowNull: false,
    },
    unitsInStock: {
      type: DataTypes.INTEGER,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'products',
    modelName: 'Product',
    timestamps: false,
  },
);
```

```typescript collapsable copy filename="src/db/models/order.ts"
import { DataTypes, Model } from 'sequelize';
import { sequelize } from '../db';

export class Order extends Model {}

Order.init(
  {
    id: {
      type: DataTypes.INTEGER,
      autoIncrement: true,
      primaryKey: true,
    },
    orderDate: {
      type: DataTypes.DATE,
      allowNull: false,
    },
    shippedDate: {
      type: DataTypes.DATE,
      allowNull: true,
    },
    shipAddress: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
    shipPostalCode: {
      type: DataTypes.TEXT,
      allowNull: true,
    },
    shipCountry: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'orders',
    modelName: 'Order',
    timestamps: false,
  },
);
```

```typescript collapsable copy filename="src/db/models/order-detail.ts"
import { DataTypes, Model } from 'sequelize';
import { sequelize } from '../db';
import { Order } from './order';
import { Product } from './product';

export class OrderDetail extends Model {}

OrderDetail.init(
  {
    orderId: {
      type: DataTypes.INTEGER,
      primaryKey: true,
      references: {
        model: Order,
        key: 'id',
      },
      field: 'orderId',
    },
    productId: {
      type: DataTypes.INTEGER,
      primaryKey: true,
      references: {
        model: Product,
        key: 'id',
      },
      field: 'productId',
    },
    quantity: {
      type: DataTypes.INTEGER,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'order_details',
    modelName: 'OrderDetail',
    timestamps: false,
  },
);

Order.hasMany(OrderDetail, { foreignKey: 'orderId', as: 'details' });
OrderDetail.belongsTo(Order, { foreignKey: 'orderId' });

Product.hasMany(OrderDetail, { foreignKey: 'productId', as: 'details' });
OrderDetail.belongsTo(Product, { foreignKey: 'productId' });

Order.belongsToMany(Product, {
  through: OrderDetail,
  foreignKey: 'orderId',
  as: 'products',
  targetKey: 'id',
});
Product.belongsToMany(Order, {
  through: OrderDetail,
  foreignKey: 'productId',
  as: 'orders',
  targetKey: 'id',
});
```

ì´ ëª¨ë¸ë“¤ì€ ë‹¤ìŒê³¼ ê°™ì€ ê´€ê³„ë¥¼ ê°€ì§‘ë‹ˆë‹¤:

1. `Supplier`ì™€ `Product` ì‚¬ì´ì˜ `ì¼ëŒ€ë‹¤` ê´€ê³„
2. `Order`ì™€ `Product` ì‚¬ì´ì˜ `ë‹¤ëŒ€ë‹¤` ê´€ê³„

`ë‹¤ëŒ€ë‹¤` ê´€ê³„ë¥¼ ìœ„í•´ `order_details`ë¼ëŠ” ì¡°ì¸ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤. ë”°ë¼ì„œ `Order`ì™€ `Product` ì—”í‹°í‹°ëŠ” `OrderDetail` ì—”í‹°í‹°ì™€ `ì¼ëŒ€ë‹¤` ê´€ê³„ë¥¼ ê°€ì§‘ë‹ˆë‹¤.

í•´ë‹¹ í…Œì´ë¸”ë“¤ì€ Sequelize ë§ˆì´ê·¸ë ˆì´ì…˜ì„ í†µí•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. SequelizeëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ ìë™ ìƒì„±ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì§ì ‘ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

```javascript collapsable copy filename="src/db/migrations/20231220152726-init.js"
'use strict';

module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.createTable('suppliers', {
      id: {
        type: Sequelize.INTEGER,
        autoIncrement: true,
        primaryKey: true,
      },
      companyName: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
      city: {
        type: Sequelize.TEXT,
        allowNull: true,
      },
      country: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
    });

    await queryInterface.createTable('products', {
      id: {
        type: Sequelize.INTEGER,
        autoIncrement: true,
        primaryKey: true,
      },
      name: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
      supplierId: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: {
          model: 'suppliers',
          key: 'id',
        },
        onUpdate: 'CASCADE',
        onDelete: 'SET NULL',
      },
      unitPrice: {
        type: Sequelize.DECIMAL,
        allowNull: false,
      },
      unitsInStock: {
        type: Sequelize.INTEGER,
        allowNull: false,
      },
    });

    await queryInterface.createTable('orders', {
      id: {
        type: Sequelize.INTEGER,
        autoIncrement: true,
        primaryKey: true,
      },
      orderDate: {
        type: Sequelize.DATE,
        allowNull: false,
      },
      shippedDate: {
        type: Sequelize.DATE,
        allowNull: true,
      },
      shipAddress: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
      shipPostalCode: {
        type: Sequelize.TEXT,
        allowNull: true,
      },
      shipCountry: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
    });

    await queryInterface.createTable('order_details', {
      orderId: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        references: {
          model: 'orders',
          key: 'id',
        },
        onUpdate: 'CASCADE',
        onDelete: 'CASCADE',
      },
      productId: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        references: {
          model: 'products',
          key: 'id',
        },
        onUpdate: 'CASCADE',
        onDelete: 'CASCADE',
      },
      quantity: {
        type: Sequelize.INTEGER,
        allowNull: false,
      },
    });
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.dropTable('order_details');
    await queryInterface.dropTable('orders');
    await queryInterface.dropTable('products');
    await queryInterface.dropTable('suppliers');
  },
};
```

ì´ ê°€ì´ë“œì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ íŒŒì¼ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

```text
ğŸ“¦ <project root>
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ db
 â”‚  â”‚  â”œ ğŸ“‚ migrations
 â”‚  â”‚  â”‚  â”” ğŸ“œ 20231220152726-init.js
 â”‚  â”‚  â”œ ğŸ“‚ models
 â”‚  â”‚  â”‚  â”œ ğŸ“œ order-detail.ts
 â”‚  â”‚  â”‚  â”œ ğŸ“œ order.ts
 â”‚  â”‚  â”‚  â”œ ğŸ“œ product.ts
 â”‚  â”‚  â”‚  â”” ğŸ“œ supplier.ts
 â”‚  â”‚  â”œ ğŸ“œ db.ts
 â”‚  â”‚  â”” ğŸ“œ config.js
 â”‚  â”œ ğŸ“‚ routers
 â”‚  â”‚  â”œ ğŸ“œ order.router.ts
 â”‚  â”‚  â”œ ğŸ“œ product.router.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.router.ts
 â”‚  â”œ ğŸ“‚ controllers
 â”‚  â”‚  â”œ ğŸ“œ order.controller.ts
 â”‚  â”‚  â”œ ğŸ“œ product.controller.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.controller.ts
 â”‚  â”œ ğŸ“œ index.ts
 â”‚  â”” ğŸ“œ server.ts
 â”œ ğŸ“œ .sequelizerc
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

<Steps>

#### Drizzle ORMê³¼ Drizzle Kit ì„¤ì¹˜í•˜ê¸°

ë¨¼ì € **Drizzle ORM**ê³¼ ë“œë¼ì´ë²„ë¡œ ì‚¬ìš©í•  `pg` íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤. ê·¸ë‹¤ìŒìœ¼ë¡œ **Drizzle Kit**ê³¼ `pg`ì˜ íƒ€ì… ì •ì˜ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤. [Drizzle Kit](/docs/kit-overview)ì€ ìë™ SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±ê³¼ ë¹ ë¥¸ í”„ë¡œí† íƒ€ì´í•‘ì„ ìœ„í•œ CLI ë„êµ¬ì…ë‹ˆë‹¤.

<Npm>
drizzle-orm pg
-D drizzle-kit @types/pg
</Npm>


#### Drizzle ì„¤ì • íŒŒì¼ ì„¤ì •í•˜ê¸°

**Drizzle ì„¤ì • íŒŒì¼**ì€ **Drizzle Kit**ì—ì„œ ì‚¬ìš©í•˜ëŠ” êµ¬ì„± íŒŒì¼ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´, ë§ˆì´ê·¸ë ˆì´ì…˜ í´ë”, ìŠ¤í‚¤ë§ˆ íŒŒì¼ ë“±ì— ëŒ€í•œ ëª¨ë“  ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `drizzle.config.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•˜ì„¸ìš”:

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config'; // dotenv íŒ¨í‚¤ì§€ ì„¤ì¹˜ í•„ìš”
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql', // ë°ì´í„°ë² ì´ìŠ¤ ì¢…ë¥˜
  out: './src/drizzle', // ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ ìƒì„±ë  ê²½ë¡œ
  schema: './src/drizzle/schema.ts', // ìŠ¤í‚¤ë§ˆ íŒŒì¼ ê²½ë¡œ
  dbCredentials: {
    host: process.env.DB_HOST!, // ë°ì´í„°ë² ì´ìŠ¤ í˜¸ìŠ¤íŠ¸
    port: Number(process.env.DB_PORT!), // ë°ì´í„°ë² ì´ìŠ¤ í¬íŠ¸
    user: process.env.DB_USERNAME!, // ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ìëª…
    password: process.env.DB_PASSWORD!, // ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸
    database: process.env.DB_NAME!, // ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
  },
  verbose: true, // ëª¨ë“  SQL ë¬¸ ì¶œë ¥
  strict: true, // í•­ìƒ í™•ì¸ ìš”ì²­
});
```

ì´ ì„¤ì • íŒŒì¼ì€ Drizzle Kitì´ ë°ì´í„°ë² ì´ìŠ¤ì™€ ìƒí˜¸ì‘ìš©í•˜ëŠ” ë° í•„ìš”í•œ ëª¨ë“  ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤. `dotenv` íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ í™˜ê²½ ë³€ìˆ˜ë¥¼ ë¡œë“œí•˜ê³ , ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. `verbose` ì˜µì…˜ì„ í†µí•´ ëª¨ë“  SQL ë¬¸ì„ ì¶œë ¥í•˜ê³ , `strict` ì˜µì…˜ì„ í†µí•´ í•­ìƒ í™•ì¸ì„ ìš”ì²­í•˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


#### ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ë¶„ì„í•˜ê¸°

**Drizzle Kit**ì€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë¶„ì„í•˜ê³  ìŠ¤í‚¤ë§ˆ íŒŒì¼ì„ ìƒì„±í•˜ëŠ” CLI ëª…ë ¹ì–´ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ ìŠ¤í‚¤ë§ˆ íŒŒì¼ì—ëŠ” ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”, ì»¬ëŸ¼, ê´€ê³„, ì¸ë±ìŠ¤ì— ëŒ€í•œ ëª¨ë“  ì •ë³´ê°€ í¬í•¨ë©ë‹ˆë‹¤.

```bash
npx drizzle-kit introspect
```

ì´ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ `src/drizzle` í´ë”ì— `schema.ts` íŒŒì¼ê³¼ ìŠ¤ëƒ…ìƒ·, ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤.

```typescript collapsable copy filename="src/drizzle/schema.ts"
import {
  pgTable,
  varchar,
  serial,
  text,
  foreignKey,
  integer,
  numeric,
  timestamp,
  primaryKey,
} from 'drizzle-orm/pg-core';
import { relations, sql } from 'drizzle-orm';

export const sequelizeMeta = pgTable('SequelizeMeta', {
  name: varchar('name', { length: 255 }).primaryKey().notNull(),
});

export const suppliers = pgTable('suppliers', {
  id: serial('id').primaryKey().notNull(),
  companyName: text('companyName').notNull(),
  city: text('city'),
  country: text('country').notNull(),
});

export const products = pgTable('products', {
  id: serial('id').primaryKey().notNull(),
  name: text('name').notNull(),
  supplierId: integer('supplierId')
    .notNull()
    .references(() => suppliers.id, { onDelete: 'set null', onUpdate: 'cascade' }),
  unitPrice: numeric('unitPrice').notNull(),
  unitsInStock: integer('unitsInStock').notNull(),
});

export const orders = pgTable('orders', {
  id: serial('id').primaryKey().notNull(),
  orderDate: timestamp('orderDate', { withTimezone: true, mode: 'string' }).notNull(),
  shippedDate: timestamp('shippedDate', { withTimezone: true, mode: 'string' }),
  shipAddress: text('shipAddress').notNull(),
  shipPostalCode: text('shipPostalCode'),
  shipCountry: text('shipCountry').notNull(),
});

export const orderDetails = pgTable(
  'order_details',
  {
    orderId: integer('orderId')
      .notNull()
      .references(() => orders.id, { onDelete: 'cascade', onUpdate: 'cascade' }),
    productId: integer('productId')
      .notNull()
      .references(() => products.id, { onDelete: 'cascade', onUpdate: 'cascade' }),
    quantity: integer('quantity').notNull(),
  },
  (table) => {
    return {
      orderDetailsPkey: primaryKey({ columns: [table.orderId, table.productId], name: 'order_details_pkey' }),
    };
  },
);
```

```sql collapsable copy filename="src/drizzle/0000_high_rhodey.sql"
-- í˜„ì¬ SQL íŒŒì¼ì€ ë°ì´í„°ë² ì´ìŠ¤ ë¶„ì„ í›„ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

CREATE TABLE IF NOT EXISTS "SequelizeMeta" (
	"name" varchar(255) PRIMARY KEY NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "suppliers" (
	"id" serial PRIMARY KEY NOT NULL,
	"companyName" text NOT NULL,
	"city" text,
	"country" text NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "products" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"supplierId" integer NOT NULL,
	"unitPrice" numeric NOT NULL,
	"unitsInStock" integer NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "orders" (
	"id" serial PRIMARY KEY NOT NULL,
	"orderDate" timestamp with time zone NOT NULL,
	"shippedDate" timestamp with time zone,
	"shipAddress" text NOT NULL,
	"shipPostalCode" text,
	"shipCountry" text NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "order_details" (
	"orderId" integer NOT NULL,
	"productId" integer NOT NULL,
	"quantity" integer NOT NULL,
	CONSTRAINT order_details_pkey PRIMARY KEY("orderId","productId")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "products" ADD CONSTRAINT "products_supplierId_fkey" FOREIGN KEY ("supplierId") REFERENCES "suppliers"("id") ON DELETE set null ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "order_details" ADD CONSTRAINT "order_details_orderId_fkey" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE cascade ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "order_details" ADD CONSTRAINT "order_details_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE cascade ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

ë˜í•œ, ê´€ê³„í˜• ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ìŠ¤í‚¤ë§ˆ íŒŒì¼ì— ê´€ê³„í˜• í…Œì´ë¸”ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤:

```typescript copy filename="src/drizzle/schema.ts"
// ...ë‹¤ë¥¸ import
import { relations } from 'drizzle-orm';

// ...ë‹¤ë¥¸ í…Œì´ë¸” 
export const suppliersRelations = relations(suppliers, ({ many }) => ({
  products: many(products),
}));

export const productsRelations = relations(products, ({ one, many }) => ({
  supplier: one(suppliers, { fields: [products.supplierId], references: [suppliers.id] }),
  orderDetails: many(orderDetails),
}));

export const ordersRelations = relations(orders, ({ many }) => ({
  orderDetails: many(orderDetails),
}));

export const orderDetailsRelations = relations(orderDetails, ({ one }) => ({
  order: one(orders, { fields: [orderDetails.orderId], references: [orders.id] }),
  product: one(products, { fields: [orderDetails.productId], references: [products.id] }),
}));
```

ì´ì œ ë‹¤ìŒê³¼ ê°™ì€ íŒŒì¼ êµ¬ì¡°ê°€ ìƒì„±ë©ë‹ˆë‹¤:

```text
ğŸ“¦ <project root>
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ drizzle
 â”‚  â”‚  â”œ ğŸ“‚ meta
 |  |  |  â”œ ğŸ“œ _journal.json
 â”‚  â”‚  â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚  â”‚  â”œ ğŸ“œ 0000_lush_lenny_balinger.sql
 â”‚  â”‚  â”” ğŸ“œ schema.ts
 â”‚  â”œ ğŸ“‚ routers
 â”‚  â”‚  â”œ ğŸ“œ order.router.ts
 â”‚  â”‚  â”œ ğŸ“œ product.router.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.router.ts
 â”‚  â”œ ğŸ“‚ controllers
 â”‚  â”‚  â”œ ğŸ“œ order.controller.ts
 â”‚  â”‚  â”œ ğŸ“œ product.controller.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.controller.ts
 â”‚  â”œ ğŸ“œ index.ts
 â”‚  â”” ğŸ“œ server.ts
 â”œ ğŸ“œ package.json
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ tsconfig.json
```


#### Drizzle ORMì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ê¸°

`src/drizzle` í´ë” ì•ˆì— `db.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •ì„ êµ¬ì„±í•©ë‹ˆë‹¤:

```typescript
import { drizzle } from 'drizzle-orm/node-postgres';
import { Client } from 'pg';
import * as schema from './schema';

export const client = new Client({
  host: process.env.DB_HOST!,
  port: Number(process.env.DB_PORT!),
  user: process.env.DB_USERNAME!,
  password: process.env.DB_PASSWORD!,
  database: process.env.DB_NAME!,
});

// { schema }ëŠ” ê´€ê³„í˜• ì¿¼ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤
export const db = drizzle({ client, schema });
```

```typescript
import 'dotenv/config';
import { client, db } from './drizzle/db';
import { resolve } from 'node:path';
import { migrate } from 'drizzle-orm/node-postgres/migrator';

(async () => {
  await client.connect();

  // ì´ ì»¤ë§¨ë“œëŠ” migrations í´ë”ì˜ ëª¨ë“  ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ë³€ê²½ ì‚¬í•­ì„ ì ìš©í•©ë‹ˆë‹¤
  await migrate(db, { migrationsFolder: resolve(__dirname, './drizzle') });

  // ... ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
})();
```


#### Sequelize ì¿¼ë¦¬ë¥¼ Drizzle ORM ì¿¼ë¦¬ë¡œ ì „í™˜í•˜ê¸°

ì´ë²ˆ ì„¹ì…˜ì—ì„œëŠ” **Sequelize**ì˜ ì—¬ëŸ¬ ì¿¼ë¦¬ë¥¼ **Drizzle ORM**ìœ¼ë¡œ ëŒ€ì²´í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤.


##### ë°ì´í„° ì‚½ì… ì¿¼ë¦¬ ë³€ê²½í•˜ê¸°

`suppliers`ì™€ `products` í…Œì´ë¸”ì— ìƒˆë¡œìš´ í–‰ì„ ì‚½ì…í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

1. `POST /suppliers`

```typescript copy filename="src/controllers/supplier.controller.ts"
import { Supplier } from '../db/models/supplier';

const suppliers = await Supplier.bulkCreate([
  {
    companyName: 'TestCompanyName1',
    city: 'TestCity1',
    country: 'TestCountry1',
  },
  {
    companyName: 'TestCompanyName2',
    city: 'TestCity2',
    country: 'TestCountry2',
  },
]);
```

**Drizzle ORM**ì„ ì‚¬ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript copy filename="src/controllers/supplier.controller.ts"
import { db } from '../drizzle/db';
import { suppliers } from '../drizzle/schema';

await db.insert(suppliers).values([
  {
    companyName: 'TestCompanyName1',
    city: 'TestCity1',
    country: 'TestCountry1',
  },
  {
    companyName: 'TestCompanyName2',
    city: 'TestCity2',
    country: 'TestCountry2',
  },
]);
```

2. `POST /products`

```typescript copy filename="src/controllers/product.controller.ts"
import { Product } from '../db/models/product';

const products = await Product.bulkCreate([
  {
    name: 'TestProductName1',
    supplierId: 1,
    unitPrice: 10,
    unitsInStock: 20,
  },
  {
    name: 'TestProductName2',
    supplierId: 1,
    unitPrice: 25,
    unitsInStock: 7,
  },
  {
    name: 'TestProductName3',
    supplierId: 2,
    unitPrice: 50,
    unitsInStock: 17,
  },
  {
    name: 'TestProductName4',
    supplierId: 2,
    unitPrice: 100,
    unitsInStock: 2,
  },
]);
```

**Drizzle ORM**ì„ ì‚¬ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`unitPrice` í•„ë“œì— ì£¼ì˜í•˜ì„¸ìš”. **Sequelize**ì—ì„œëŠ” `number` íƒ€ì…ì´ì§€ë§Œ, **Drizzle ORM**ì—ì„œëŠ” `string` íƒ€ì…ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤. ì´ëŠ” ì†Œìˆ˜ì  ì´í•˜ 16383ìë¦¬ ì´ìƒì˜ ìˆ«ìë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

```typescript copy filename="src/controllers/product.controller.ts"
await db.insert(products).values([
  {
    name: 'TestProductName1',
    supplierId: 1,
    unitPrice: '10',
    unitsInStock: 20,
  },
  {
    name: 'TestProductName2',
    supplierId: 1,
    unitPrice: '25',
    unitsInStock: 7,
  },
  {
    name: 'TestProductName3',
    supplierId: 2,
    unitPrice: '50',
    unitsInStock: 17,
  },
  {
    name: 'TestProductName4',
    supplierId: 2,
    unitPrice: '100',
    unitsInStock: 2,
  },
]);
```


##### ì¿¼ë¦¬ ì„ íƒ ëŒ€ì²´í•˜ê¸°

ì´ë²ˆ ì„¹ì…˜ì—ì„œëŠ” ë‹¨ì¼ í–‰ ì„ íƒ, ì—¬ëŸ¬ í–‰ ì„ íƒ, í–‰ ê°œìˆ˜ ì„¸ê¸°, í–‰ í•„í„°ë§, í…Œì´ë¸” ì¡°ì¸, ê²°ê³¼ í˜ì´ì§• ë°©ë²•ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

1. `GET /products/:id`

**Sequelize**ì—ì„œëŠ” ì‘ë‹µ íƒ€ì…ì´ ì—„ê²©í•˜ê²Œ íƒ€ì…í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ê´€ê³„ë¥¼ í¬í•¨í•˜ê±°ë‚˜ ì¼ë¶€ í•„ë“œë§Œ ì„ íƒí•˜ëŠ” ê²½ìš°, ì´ëŸ¬í•œ ìˆ˜ì • ì‚¬í•­ì´ ì‘ë‹µ íƒ€ì…ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```typescript copy filename="src/controllers/product.controller.ts"
import { Product } from '../db/models/product';
import { Supplier } from '../db/models/supplier';

const { id } = req.params;

const response = await Product.findByPk(id, {
  include: Supplier,
});
```

**Drizzle ORM**ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì¿¼ë¦¬ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤:

```typescript copy filename="src/controllers/product.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products, suppliers } from '../drizzle/schema';

const { id } = req.params;

const response = await db
  .select({
    product: products,
    supplier: suppliers,
  })
  .from(products)
  .where(eq(products.id, id))
  .leftJoin(suppliers, eq(suppliers.id, products.supplierId));

// ë˜ëŠ” ê´€ê³„í˜• ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
const response = await db.query.products.findFirst({
  where: (products, { eq }) => eq(products.id, id),
  with: {
    supplier: true,
  },
});
```

**Drizzle ORM**ì—ì„œëŠ” ì‘ë‹µ íƒ€ì…ì´ select ê°ì²´ì— ì§€ì •ëœ ë‚´ìš©ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ë¯€ë¡œ, `supplier` ê´€ê³„ë¥¼ í¬í•¨í•˜ëŠ” ê²ƒì´ ì™„ì „íˆ íƒ€ì… ì•ˆì „í•©ë‹ˆë‹¤.

```typescript
// ì‘ë‹µ íƒ€ì…
const response: {
  product: {
    name: string;
    id: number;
    supplierId: number;
    unitPrice: string;
    unitsInStock: number;
  };
  supplier: {
    id: number;
    companyName: string;
    city: string | null;
    country: string;
  } | null;
}[]
```

2. `GET /products`

**Sequelize**ì—ì„œëŠ” ì„ íƒí•  í•„ë“œë¥¼ ëª…ì‹œí•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ê²°ê³¼ê°€ íƒ€ì… ì•ˆì „í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```typescript copy filename="src/controllers/product.controller.ts"
import { Product } from '../db/models/product';
import { Op } from 'sequelize';

const { rows, count } = await Product.findAndCountAll({
  limit: 10,
  offset: 0,
  attributes: ['id', 'name', 'unitPrice', 'unitsInStock'],
  where: {
    name: {
      [Op.iLike]: `%test%`,
    },
  },
});
```

**Drizzle ORM**ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì¿¼ë¦¬ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤:

```typescript collapsable copy filename="src/controllers/product.controller.ts"
import { ilike, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products } from '../drizzle/schema';

const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db
    .select({
      id: products.id,
      name: products.name,
      unitPrice: products.unitPrice,
      unitsInStock: products.unitsInStock,
    })
    .from(products)
    .where(whereOptions)
    .offset(0)
    .limit(10),
  db
    .select({ count: sql`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);

// ë˜ëŠ” ê´€ê³„í˜• ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db.query.products.findMany({
    where: whereOptions,
    columns: {
      id: true,
      name: true,
      unitPrice: true,
      unitsInStock: true,
    },
    offset: 0,
    limit: 10,
  }),
  db
    .select({ count: sql`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);
```

**Drizzle ORM**ì—ì„œëŠ” ê²°ê³¼ê°€ ì—„ê²©í•˜ê²Œ íƒ€ì… ì•ˆì „í•˜ë¯€ë¡œ, ì„ íƒí•œ í•„ë“œê°€ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜ë©ë‹ˆë‹¤.

```typescript
// ì‘ë‹µ íƒ€ì…
const response: {
  id: number;
  name: string;
  unitPrice: string;
  unitsInStock: number;
}[]
```

3. `GET /orders/:id`

**Sequelize**ì—ì„œëŠ” `findByPk`ì™€ ê°™ì€ ë©”ì„œë“œë¡œ ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ êµ¬í˜„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ íƒ€ì… ì•ˆì „í•˜ì§€ ì•Šì€ raw ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

`orders` í…Œì´ë¸”ì—ì„œ `id`, `orderDate`, `shipCountry` í•„ë“œë¥¼ ì„ íƒí•˜ê³ , `aggregation functions`ë¥¼ ì‚¬ìš©í•´ ì£¼ë¬¸ì˜ `totalPrice`, ì£¼ë¬¸ ë‚´ ì œí’ˆì˜ `totalQuantity`, ì£¼ë¬¸ ë‚´ ì œí’ˆ ìˆ˜ `totalProducts`ë¥¼ í•©ì‚°í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

```typescript copy filename="src/controllers/order.controller.ts"
import { sequelize } from '../db/db';
import { QueryTypes } from 'sequelize';

const { id } = req.params;

const response = await sequelize.query(
      `
SELECT 
  orders.id,
  orders."orderDate",
  orders."shipCountry",
  SUM(products."unitPrice" * order_details.quantity)::float AS "totalPrice",
  SUM(order_details.quantity)::int AS "totalQuantity",
  COUNT(order_details."productId")::int AS "totalProducts"
FROM orders
LEFT JOIN order_details ON orders.id = order_details."orderId"
LEFT JOIN products ON order_details."productId" = products.id
WHERE orders.id = :orderId
GROUP BY orders.id
`,
      {
        replacements: { orderId: id },
        type: QueryTypes.SELECT,
      },
    );
```

**Drizzle ORM**ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì¿¼ë¦¬ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤:

```typescript copy filename="src/controllers/order.controller.ts"
import { eq, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orders, orderDetails, products } from '../drizzle/schema';

const { id } = req.params;

const response = await db
      .select({
        id: orders.id,
        shipCountry: orders.shipCountry,
        orderDate: orders.orderDate,
        totalPrice: sql`cast(sum(${orderDetails.quantity} * ${products.unitPrice}) as float)`,
        totalQuantity: sql`cast(sum(${orderDetails.quantity}) as int)`,
        totalProducts: sql`cast(count(${orderDetails.productId}) as int)`,
      })
      .from(orders)
      .where(eq(orders.id, id))
      .groupBy(orders.id)
      .leftJoin(orderDetails, eq(orderDetails.orderId, orders.id))
      .leftJoin(products, eq(products.id, orderDetails.productId));
```

**Drizzle ORM**ì—ì„œëŠ” ì§‘ê³„ ê²°ê³¼ë„ íƒ€ì… ì•ˆì „í•©ë‹ˆë‹¤.

```typescript
// ì‘ë‹µ íƒ€ì…
const response: {
  id: number;
  shipCountry: string;
  orderDate: string;
  totalPrice: number;
  totalQuantity: number;
  totalProducts: number;
}[]
```

**ì°¸ê³ :** í˜„ì¬ë¡œì„œëŠ” ê´€ê³„í˜• ì¿¼ë¦¬ì—ì„œ ì§‘ê³„ê°€ ì§€ì›ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, `core queries`ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.


##### ì—¬ëŸ¬ í–‰ ì—…ë°ì´íŠ¸í•˜ê¸°

ì´ë²ˆ ì„¹ì…˜ì—ì„œëŠ” ì—¬ëŸ¬ í–‰ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

1. `PATCH /suppliers/:id`

```typescript copy filename="src/controllers/supplier.controller.ts"
import { Supplier } from '../db/models/supplier';

const { id } = req.params;

const supplier = await Supplier.findByPk(1);
if (!supplier) {
  throw new Error('Supplier not found');
}

supplier.set({
  city: 'TestCity1Updated',
  country: 'TestCountry1Updated',
});

await supplier.save();
```

**Drizzle ORM**ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì¿¼ë¦¬ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```typescript copy filename="src/controllers/supplier.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { suppliers } from '../drizzle/schema';

const { id } = req.params;

await db
    .update(suppliers)
    .set({
      city: 'TestCity1Updated',
      country: 'TestCountry1Updated',
    })
    .where(eq(suppliers.id, id));
```


### ì‚­ì œ ì¿¼ë¦¬ ëŒ€ì²´í•˜ê¸°

ì´ë²ˆ ì„¹ì…˜ì—ì„œëŠ” íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ë‹¨ì¼ í–‰ê³¼ ì—¬ëŸ¬ í–‰ì„ ì‚­ì œí•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

1. `DELETE /orders/:id`

```typescript copy filename="src/controllers/order.controller.ts"
import { Order } from '../db/models/order';
import { OrderDetail } from '../db/models/order-detail';
import { sequelize } from '../db/db';

const { id } = req.params;

try {
  const order = await Order.findByPk(id);
  if (!order) {
    throw new Error('ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }

  await sequelize.transaction(async (t) => {
    await OrderDetail.destroy({
      where: {
        orderId: id,
      },
      transaction: t,
    });

    await order.destroy({ transaction: t });
  });
} catch (e) {
  console.error(e);
}
```

**Drizzle ORM**ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì¿¼ë¦¬ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```typescript copy filename="src/controllers/order.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orderDetails, orders } from '../drizzle/schema';

const { id } = req.params;

try {
  await db.transaction(async (tx) => {
    await tx.delete(orderDetails).where(eq(orderDetails.orderId, id));

    await tx.delete(orders).where(eq(orders.id, id));
  });
} catch (e) {
  console.error(e);
}
```

</Steps>


